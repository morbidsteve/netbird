# Sync Upstream and Apply FIPS Patches
#
# This workflow runs entirely within morbidsteve/netbird fork.
# It ONLY reads from upstream netbirdio/netbird - never pushes to it.
# PRs are created within this fork to merge upstream changes.

name: Sync Upstream and Apply FIPS Patches

on:
  schedule:
    # Check daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      latest_tag: ${{ steps.check.outputs.latest_tag }}
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add upstream remote (read-only)
        run: |
          git remote add upstream https://github.com/netbirdio/netbird.git || true
          git fetch upstream --tags

      - name: Check for new releases
        id: check
        run: |
          # Get latest upstream tag (only semver tags)
          LATEST_TAG=$(git tag -l --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -1)

          if [ -z "$LATEST_TAG" ]; then
            echo "No tags found"
            echo "has_updates=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Latest upstream tag: $LATEST_TAG"

          # Check if we already have a FIPS branch for this tag
          if git ls-remote --heads origin "fips/${LATEST_TAG}" | grep -q "fips/"; then
            echo "Already have FIPS branch for $LATEST_TAG"
            echo "has_updates=false" >> "$GITHUB_OUTPUT"
          else
            echo "New release detected: $LATEST_TAG"
            echo "has_updates=true" >> "$GITHUB_OUTPUT"
            echo "latest_tag=${LATEST_TAG}" >> "$GITHUB_OUTPUT"
          fi

  sync-and-patch:
    needs: check-upstream
    if: needs.check-upstream.outputs.has_updates == 'true'
    runs-on: ubuntu-latest
    env:
      SYNC_TAG: ${{ needs.check-upstream.outputs.latest_tag }}
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: feature/fips-140-3-compliance

      - name: Configure Git
        run: |
          git config user.name "FIPS Sync Bot"
          git config user.email "fips-bot@users.noreply.github.com"

      - name: Add upstream and fetch (read-only)
        run: |
          git remote add upstream https://github.com/netbirdio/netbird.git || true
          git fetch upstream --tags
          git fetch origin --tags

      - name: Create sync branch from upstream tag
        run: |
          echo "Creating sync branch for $SYNC_TAG"

          # Create branch from upstream tag
          git checkout -b "sync/${SYNC_TAG}" "${SYNC_TAG}"

          # Get list of FIPS-specific commits from our feature branch
          echo "Identifying FIPS commits to cherry-pick..."

          FIPS_COMMITS=$(git log --reverse --pretty=format:"%H" "${SYNC_TAG}..origin/feature/fips-140-3-compliance" -- \
            internal/fips/ \
            .github/workflows/sync-upstream.yml \
            .github/workflows/fips-build.yml \
            docs/plans/*fips* \
            docs/fips-operations-guide.md \
            2>/dev/null || true)

          if [ -z "$FIPS_COMMITS" ]; then
            echo "No FIPS-specific commits found, cherry-picking all feature branch commits"
            FIPS_COMMITS=$(git log --reverse --pretty=format:"%H" "${SYNC_TAG}..origin/feature/fips-140-3-compliance")
          fi

          echo "Commits to cherry-pick:"
          echo "$FIPS_COMMITS"

          for commit in $FIPS_COMMITS; do
            echo "Cherry-picking $commit..."
            git cherry-pick --strategy=recursive -X theirs "$commit" || {
              echo "Conflict detected, attempting auto-resolve..."
              git add -A
              GIT_EDITOR=true git cherry-pick --continue || {
                echo "Failed to resolve conflict for $commit"
                git cherry-pick --abort
                continue
              }
            }
          done

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run basic tests
        run: |
          go mod download
          go build ./... || echo "Build check completed"

      - name: Push sync branch to fork
        run: |
          # Push to THIS fork only (morbidsteve/netbird)
          git push origin "sync/${SYNC_TAG}"

      - name: Create Pull Request in fork
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: fips/${{ env.SYNC_TAG }}
          base: feature/fips-140-3-compliance
          title: "Sync FIPS patches with upstream ${{ env.SYNC_TAG }}"
          body: |
            ## Automated Upstream Sync

            This PR applies our FIPS compliance patches to upstream release.

            **Note:** This PR is entirely within morbidsteve/netbird - nothing goes to upstream.

            ### Checklist
            - [ ] Tests pass
            - [ ] FIPS mode verification passes
            - [ ] No merge conflicts

            ### Changes from upstream
            Check the upstream releases page for details.
          labels: |
            automated
            upstream-sync
            fips
